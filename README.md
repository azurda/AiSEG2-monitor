# AiSEG2 ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯ AiSEG2 ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ¢ãƒ‹ã‚¿ãƒ¼å‘ã‘ã®ãƒ­ãƒ¼ã‚«ãƒ« PWA ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã™ã€‚
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é›»åŠ›ãƒ•ãƒ­ãƒ¼ãƒ»æ—¥æ¬¡é›»åŠ›é›†è¨ˆãƒ»åˆ†å²å›è·¯åˆ¥ä½¿ç”¨é‡ã®é–²è¦§ã€ãŠã‚ˆã³ã‚¨ã‚¢ã‚³ãƒ³ãƒ»åºŠæš–æˆ¿ãƒ»ã‚¨ãƒãƒ•ã‚¡ãƒ¼ãƒ ã®æ“ä½œãŒã§ãã¾ã™ã€‚

---

## æ©Ÿèƒ½

- âš¡ **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é›»åŠ›ãƒ•ãƒ­ãƒ¼** â€” å¤ªé™½å…‰ãƒ»ã‚¨ãƒãƒ•ã‚¡ãƒ¼ãƒ ã®ç™ºé›»é‡ã€æ¶ˆè²»é‡ã€å£²è²·é›»ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºï¼ˆ5ç§’æ›´æ–°ï¼‰
- ğŸ“Š **æ—¥æ¬¡é›†è¨ˆ** â€” ä»Šæ—¥ã®ç™ºé›»ãƒ»æ¶ˆè²»ãƒ»è²·é›»ãƒ»å£²é›»ã® kWh ã‚’è¡¨ç¤º
- ğŸ”Œ **å›è·¯åˆ¥ä½¿ç”¨é‡** â€” 38å›è·¯ã®ä»Šæ—¥ã® kWh ã‚’ä¸€è¦§è¡¨ç¤º
- ğŸŒ¡ï¸ **æ©Ÿå™¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«**
  - ã‚¨ã‚¢ã‚³ãƒ³Aãƒ»Bãƒ»C ã®å€‹åˆ¥é‹è»¢/åœæ­¢ï¼ˆå®¤å†…ãƒ»å®¤å¤–æ¸©åº¦ãƒ»æ¹¿åº¦è¡¨ç¤ºä»˜ãï¼‰
  - ã‚¨ã‚¢ã‚³ãƒ³ã®è©³ç´°è¨­å®šï¼šè¨­å®šæ¸©åº¦ï¼ˆ16ã€œ30â„ƒï¼‰ãƒ»ãƒ¢ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•/å†·æˆ¿/æš–æˆ¿/é™¤æ¹¿/é€é¢¨ï¼‰ãƒ»é¢¨é‡ï¼ˆè‡ªå‹•/1ã€œ6ï¼‰
  - åºŠæš–æˆ¿Aãƒ»B ã®å€‹åˆ¥é‹è»¢/åœæ­¢ï¼ˆæ¸©åº¦ãƒ¬ãƒ™ãƒ«1ã€œ9 ã®ãã®å ´å¤‰æ›´ä»˜ãï¼‰
  - ã‚¨ãƒãƒ•ã‚¡ãƒ¼ãƒ ï¼šãµã‚è‡ªå‹•ã®ON/OFFãƒ»ç™ºé›»ã®ON/OFF
- âœï¸ **ã‚«ã‚¹ã‚¿ãƒ åç§°** â€” ã‚¨ã‚¢ã‚³ãƒ³ãƒ»åºŠæš–æˆ¿ã®è¡¨ç¤ºåã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§è‡ªç”±ã«å¤‰æ›´å¯èƒ½ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ `nicknames.json` ã«ä¿å­˜ï¼‰
- ğŸ“± **PWA** â€” ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«ä½¿ç”¨å¯èƒ½
- ğŸ” **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ** â€” WebSocket ãŒåˆ‡æ–­ã•ã‚Œã¦ã‚‚ REST ãƒãƒ¼ãƒªãƒ³ã‚°ã§ç¶™ç¶šæ›´æ–°ã€‚ç”»é¢å¾©å¸°æ™‚ã«å³æ™‚å†æ¥ç¶š

---

## å¿…è¦ç’°å¢ƒ

| é …ç›® | è¦ä»¶ |
|------|------|
| Node.js | 18 ä»¥ä¸Šï¼ˆfetch API å†…è”µç‰ˆï¼‰ |
| AiSEG2 | ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ Ver.2.x ä»¥é™ï¼ˆLAN æ¥ç¶šæ¸ˆã¿ï¼‰ |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã¨ AiSEG2 ãŒåŒä¸€ LAN ä¸Šã«ã‚ã‚‹ã“ã¨ |

---

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ãƒªãƒã‚¸ãƒˆãƒªã®å–å¾—

```bash
git clone <ã“ã®ãƒªãƒã‚¸ãƒˆãƒª> aiseg2
cd aiseg2
```

### 2. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install
```

### 3. è¨­å®šã®å¤‰æ›´ï¼ˆå¿…è¦ãªå ´åˆï¼‰

`aiseg2.js` ã®å…ˆé ­ã«ã‚ã‚‹ä»¥ä¸‹ã®å®šæ•°ã‚’ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```js
const BASE = 'http://192.168.0.216';  // AiSEG2 ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹
const USER = 'aiseg';                  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆé€šå¸¸å¤‰æ›´ä¸è¦ï¼‰
const PASS = '1234567890';             // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆAiSEG2 æœ¬ä½“ã§ç¢ºèªï¼‰
```

### 4. èµ·å‹•

```bash
npm start
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://<ã‚µãƒ¼ãƒãƒ¼IP>:3000` ã‚’é–‹ãã¾ã™ã€‚

---

## ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å¸¸æ™‚èµ·å‹•ã™ã‚‹

### Linuxï¼ˆsystemdï¼‰

```bash
bash install-linux.sh
```

### macOSï¼ˆlaunchdï¼‰

```bash
bash install-macos.sh
```

è©³ç´°ã¯å¾Œè¿°ã®ã€Œãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## ãƒãƒ¼ãƒˆå¤‰æ›´

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `3000` ãƒãƒ¼ãƒˆã§ã™ã€‚å¤‰æ›´ã™ã‚‹ã«ã¯ï¼š

```bash
PORT=8080 npm start
```

ã¾ãŸã¯ `install-linux.sh` / `install-macos.sh` å†…ã® `PORT` å¤‰æ•°ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚

---

---

# AiSEG2 Dashboard

A local PWA dashboard for the Panasonic AiSEG2 home energy monitor.
View real-time power flow, daily kWh totals, per-circuit usage, and control air conditioners, floor heating, and Enefarm from any device on your LAN.

---

## Features

- âš¡ **Real-time power flow** â€” Solar, Enefarm generation, consumption, and grid buy/sell updated every 5 seconds
- ğŸ“Š **Daily totals** â€” Today's generation, consumption, purchased, and sold kWh
- ğŸ”Œ **Circuit breakdown** â€” Today's kWh for all 38 branch circuits
- ğŸŒ¡ï¸ **Device control**
  - Air conditioners A/B/C â€” individual on/off with indoor/outdoor temp and humidity
  - AC detailed settings: set temperature (16â€“30 Â°C), mode (auto/cool/heat/dry/fan), fan speed (auto/1â€“6)
  - Floor heating A/B â€” individual on/off with inline level adjustment (levels 1â€“9)
  - Enefarm â€” bath hot water (ãµã‚è‡ªå‹•) and power generation on/off
- âœï¸ **Device nicknames** â€” rename any AC or floor heater to a custom label; persisted server-side in `nicknames.json`
- ğŸ“± **PWA** â€” Add to home screen on iOS/Android for a native app feel
- ğŸ” **Resilient** â€” Falls back to REST polling when WebSocket drops; reconnects immediately on tab focus

---

## Requirements

| | |
|---|---|
| Node.js | 18+ (built-in fetch required) |
| AiSEG2 | Firmware Ver.2.x+, connected to LAN |
| Network | Dashboard server and AiSEG2 must be on the same LAN |

---

## Quick Start

```bash
git clone <this-repo> aiseg2
cd aiseg2
npm install
npm start
```

Open `http://<server-ip>:3000` in a browser on any device on the same network.

---

## Configuration

Edit the constants at the top of `aiseg2.js`:

```js
const BASE = 'http://192.168.0.216';  // AiSEG2 IP address
const USER = 'aiseg';                  // Username (usually unchanged)
const PASS = '1234567890';             // Password (printed on AiSEG2 unit)
```

---

## Hosting as a Service

### Linux (systemd â€” Arch, Ubuntu, Debian, etc.)

```bash
bash install-linux.sh
```

This installs and starts a systemd user service that survives reboots.

### macOS (launchd â€” Mac Mini, etc.)

```bash
bash install-macos.sh
```

This installs a LaunchDaemon (system-level) that starts at boot.

See the scripts for configuration options (port, user, install path).

---

## Project Structure

```
aiseg2/
â”œâ”€â”€ aiseg2.js          # AiSEG2 API client (Digest auth, all endpoints)
â”œâ”€â”€ server.js          # Express HTTP + WebSocket server
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ index.html     # PWA shell (two-tab layout)
â”‚   â”œâ”€â”€ style.css      # Dark theme styles
â”‚   â”œâ”€â”€ app.js         # Frontend JS (WS, REST fallback, device control)
â”‚   â”œâ”€â”€ sw.js          # Service worker (cache-first for static assets)
â”‚   â””â”€â”€ manifest.json  # PWA manifest
â”œâ”€â”€ install-linux.sh   # systemd service installer
â”œâ”€â”€ install-macos.sh   # launchd service installer
â”œâ”€â”€ README.md
â””â”€â”€ ARCHITECTURE.md    # AiSEG2 API reverse-engineering notes
```

---

## Development

```bash
npm run dev   # starts server with --watch for auto-reload on file changes
```

The WebSocket endpoint is at `ws://<host>:3000/ws`.
The server pushes `{type, data, ts}` frames every 5s (realtime), 60s (totals), 10s (devices).
